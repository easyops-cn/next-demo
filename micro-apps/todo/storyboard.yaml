app:
  name: Todo
  id: todo
  homepage: /todo
imports:
- '@next-bricks/basic-bricks'
- '@next-bricks/forms'
routes:
- path: ${APP.homepage}
  context:
    - name: todoList
      value: '<% LOCAL_STORAGE.getItem("todo-list") ?? [] %>'
      onChange:
      - action: localStorage.setItem
        args:
        - todo-list
        - '<% CTX.todoList %>'
      - action: context.replace
        args:
        - firstTodo
        - '<% CTX.todoList[0] %>'
    - name: firstTodo
      value: '<% CTX.todoList[0] %>'
  bricks:
  - brick: basic-bricks.micro-view
    properties:
      pageTitle: My Todos
    slots:
      content:
        type: bricks
        bricks:
        - brick: basic-bricks.general-card
          properties:
            hidden: '<% "track context", CTX.todoList.length === 0 %>'
          slots:
            content:
              type: bricks
              bricks:
              # - brick: tpl-list-container
              #   properties:
              #     data: '<% "track context", CTX.todoList.map((thing, index) => ({ thing, index })) %>'
              #   events:
              #     todo.dblclick:
              #     - action: context.replace
              #       args:
              #       - todoList
              #       - '<% CTX.todoList.filter((_, i) => i !== EVENT.detail.index) %>'
              - brick: basic-bricks.list-container
                properties:
                  data: '<% "track context", CTX.todoList.map((thing, index) => ({ thing, index })) %>'
                  useBrick:
                    brick: div
                    properties:
                      style:
                        color: |
                          <% `<% "red" %>` %>
                      title: '<% CTX.todoList.length %>'
                      # textContent: '<% `#${DATA.index + 1} ${DATA.thing}` %>'
                      textContent: '#@{index|add:1} @{thing}'
                    events:
                      dblclick:
                        action: context.replace
                        args:
                        - todoList
                        - '<% CTX.todoList.filter((_, i) => i !== DATA.index) %>'
              - brick: div
                properties:
                  textContent: 'Tips: double click a todo to mark it as DONE ✔️'
                  style:
                    color: gray
                    marginTop: 1em

        - brick: presentational-bricks.brick-descriptions
          properties:
            configProps:
              column: 2
            descriptionTitle: 基本信息
            # dataSource: '<% "track context", { index: 0, thing: CTX.firstTodo } %>'
            itemList:
            - field: index
              label: Index
            - field: thing
              label: Thing
              useBrick:
                brick: basic-bricks.popover-container
                transform:
                  data: '<% "track context", { _index: 0, _thing: CTX.firstTodo } %>'
                  displayBrick.data: '<% "track context", { __index: 0, __thing: CTX.firstTodo } %>'
                properties:
                  displayBrick:
                    useBrick:
                      brick: div
                      properties:
                        style:
                          white-space: pre-wrap
                      transform:
                        textContent: '#@{__index|add:1} @{__thing}'
                  popoverContentStyle:
                    width: 300
                  popoverBrick:
                    useBrick:
                      brick: div
                      transform:
                        textContent: '<% `No.${DATA._index + 1} ${DATA._thing}` %>'

        - brick: presentational-bricks.brick-descriptions
          properties:
            configProps:
              column: 2
            descriptionTitle: 基本信息
            # dataSource: '<% "track context", { index: 0, thing: CTX.firstTodo } %>'
            itemList:
            - field: index
              label: Index
            - field: thing
              label: Thing
              useBrick:
                brick: basic-bricks.popover-container
                properties:
                  data: '<% "track context", { _index: 0, _thing: CTX.firstTodo } %>'
                  displayBrick:
                    useBrick:
                      brick: div
                      properties:
                        style:
                          white-space: pre-wrap
                        textContent: '#@{_index|add:1} @{_thing}'
                  popoverContentStyle:
                    width: 300
                  popoverBrick:
                    useBrick:
                      brick: div
                      properties:
                        textContent: '<% `No.${DATA._index + 1} ${DATA._thing}` %>'

        - brick: basic-bricks.general-card
          slots:
            content:
              type: bricks
              bricks:
              - brick: forms.general-form
                properties:
                  layout: vertical
                  id: todoForm
                slots:
                  items:
                    type: bricks
                    bricks:
                    - brick: forms.general-input
                      properties:
                        label: What needs to be done?
                        name: thing
                        required: true
                        message:
                          required: Nothing to do?
                      events:
                        general.input.press.enter:
                          target: '#todoForm'
                          method: validate
                    - brick: forms.general-buttons
                      properties:
                        submitText: '<% "track context", `Add #${CTX.todoList.length + 1}` %>'
                        submitType: default
                events:
                  validate.success:
                  - action: console.log
                  - action: context.replace
                    args:
                    - todoList
                    - '<% [...CTX.todoList, EVENT.detail.thing] %>'
                  - target: '#todoForm'
                    method: setInitValue
                    args:
                    - thing: null

  menu:
    sidebarMenu:
      defaultCollapsed: true
meta:
  customTemplates:
  - name: tpl-list-container
    proxy:
      properties:
        data:
          ref: listContainer
          refProperty: data
    bricks:
    - brick: basic-bricks.list-container
      ref: listContainer
      properties:
        useBrick:
          brick: div
          transform:
            textContent: '<% `#${DATA.index + 1} ${DATA.thing}` %>'
          events:
            dblclick:
            - action: tpl.dispatchEvent
              args:
              - todo.dblclick
              - detail: '<% DATA %>'
